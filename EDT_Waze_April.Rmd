---
title: "EDT + Waze Joining"
output:
  html_notebook:
    df_print: paged
  html_document:
    df_print: paged
---

Initial work in mapping EDT and Waze incident data

Started 2017-12-07

Ideas:

- Frequency of events - histograms of different Waze event frequencies within a day, for different event types (accident, jam, weather hazard, road closed), and same for EDT incident count frequencies within a day
- Incident type by time of day
- Duration of incidents
- Spatial overlay of events - similar to Lia's slider idea, make a figure which builds up hotspots of Waze and EDT by day
- Spatiotemporal join - Paul's 2x2 for time (early, laggy) and space (near, far) matching of EDT and Waze, by type. In the future, using data snapped to HPMS, use roadway classification as well, or could use day of week.

```{r setup, message = F, warning = F}
# Read in libraries and set working directory
knitr::opts_chunk$set(echo = T, warning=F, message=F)
options(width = 2400, stringsAsFactors = F)

library(ggplot2)
library(tidyverse)
library(maps) # for mapping base layers
library(reshape)
library(DT) # for datatable
# devtools::install_github("ropensci/plotly") # for latest version
library(plotly) # do after ggplot2
library(sp)
library(maptools) # readShapePoly() and others
library(mapproj) # for coord_map()
library(rgdal) # for readOGR(), needed for reading in ArcM shapefiles
library(rgeos) # for gIntersection, to clip two shapefiles
library(raster)
library(knitr)
library(kableExtra)

#Set file locations
mappeddrive = "S:" # change this to match the mapped network drive on your machine (Z: in original)
#wazedir <- "W:/SDI Pilot Projects/Waze/"
wazedir <- (file.path(mappeddrive,"SDI Pilot Projects/Waze"))
volpewazedir <- "//vntscex.local/DFS/Projects/PROJ-OR02A2/SDI/"

knitr::opts_knit$set(root.dir = wazedir) 
```

```{r dataimport}

# EDT: See CrashFact in W:\SDI Pilot Projects\Volpe\2017_11_03\waze\input\edt\2016_01_to_2017_09_MD_and_IN.
# This has been reduced to just Maryland data from April 2017.
load("MASTER Data Files/Waze Aggregated/month_MD_clipped/2017-04_1_CrashFact_edited.RData")

# Waze: Comes from aggregated monthly Waze events, clipped to a 0.5 mile buffer around MD, for April 2017
load("MASTER Data Files/Waze Aggregated/month_MD_clipped/MD_buffered__2017-04.RData")

# Read in link files: three versions, one from R script using time point, one from Python script
#link1 <- read.csv("MASTER Data Files/Waze Aggregated/month_MD_clipped/EDT_Waze_link_April_MD-timepoint.csv")
link2 <- read.csv(file.path(volpewazedir, "output_mmg/link_table_edt_waze.txt"), sep = "\t")
link <- read.csv("MASTER Data Files/Waze Aggregated/month_MD_clipped/EDT_Waze_link_April_MD.csv")

# EDT_Waze_link_April_MD-timepoint.csv file deleted (used single timepoint instead of window)
# compare pairs
#link1.p <- paste(link1[,1], link1[,2])
link2.p <- paste(link2[,1], link2[,2])
link3.p <- paste(link[,1], link[,2])

#link1.p <- sort(link1.p)
link2.p <- sort(link2.p)
link3.p <- sort(link3.p)

#identical(length(link1.p), length(link2.p)) # identical!!
#length(link3.p) - length(link1.p) # additional linked records
#summary(link1.p == link2.p) # identical!

# # Read in county data from Census
# counties <- readOGR("Working Documents/Census Files", layer = "cb_2015_us_county_500k")
# md_counties <- counties[counties$STATEFP == 24,]

```


```{r linksummary, echo = F}

###Some code for subsetting EDT and Waze data based on link table

# Make sure EDT data is just for April
edt.april <- edt.april[edt.april$CrashDate_Local < "2017-05-01 00:00:00 EDT" & edt.april$CrashDate_Local > "2017-04-01 00:00:00 EDT",] 

#Add "M" code to the table to show matches if we merge in full datasets
match <- rep("M", nrow(link))
link <- mutate(link, match) #29,206
glimpse(link)
 
#Save Waze data as dataframe
waze.df <- d@data #439,562 x 20
names(waze.df)

#Save EDT data as dataframe
edt.df <- edt.april@data #9,271 x 54
names(edt.df)

#Subset of Waze data that matches EDT
#Waze.Match <- Waze.df[match(link$uuid.waze, d$uuid),]
#Waze.Match@data

#Join Waze data to link table (full join)
link.waze <- full_join(link,waze.df,by=c("uuid.waze"="uuid")) #442,500

#Join EDT data to Waze-link table (full join)
#Note:error stating "Column `CrashDate_Local` POSIXlt not supported" returned for all columns 
#Removed the column for now  
link.waze.edt <- full_join(link.waze,edt.df[,1:53],by=c("id.edt"="ID")) #446,461 x 74
#Check size - total should equal number non-matched EDT + number non-matched Waze + nrow(link table) = 446,461 (matches!)

#save the merged file as a csv file
#write.csv(link.waze.edt, file="link.waze.edt.April2017.csv")

# Save the merged Rdata file as an Rdata file
#saveRDS(link.waze.edt, file = "link.waze.edt.April2017.rds")

# stopifnot(identical(as.character(Waze.Match$uuid), link$uuid.waze) == TRUE)

## 
Total.EDT.events <- length(unique(edt.april$ID))
EDT.events.with.Waze <- length(unique(link$id.edt))
EDT.events.without.Waze <- Total.EDT.events - EDT.events.with.Waze
Pct.EDT.match <- round(100*EDT.events.with.Waze/Total.EDT.events,2)

Total.Waze.events <- length(unique(d$uuid))
Waze.events.with.EDT <- length(unique(link$uuid.waze))
Waze.events.without.EDT <- Total.Waze.events - Waze.events.with.EDT
Pct.Waze.match <- round(100*Waze.events.with.EDT/Total.Waze.events,2)

```

```{r matchtable}


mm <- matrix(c(EDT.events.with.Waze, EDT.events.without.Waze, Total.EDT.events, Pct.EDT.match,
         Waze.events.with.EDT, Waze.events.without.EDT,Total.Waze.events, Pct.Waze.match), byrow=T,
       nrow = 2, ncol = 4)

row.names(mm) <- c("EDT", "Waze")
colnames(mm) <- c("Matching", "Non-Matching", "Total", "Percent Matching")

kable(mm) %>% kable_styling(bootstrap_options = c("striped", "hover"))


# by type



```

### Initial mapping work

```{r fort.map, eval=FALSE, include=FALSE}
# Currently not run -- this is the start of making a fortified dataframe for ggplot mapping, to turn into a plotly map.
# Get points in polygons: events in each county
proj4string(edt.shp) <- proj4string(waz.shp) <- proj4string(md_counties)

md_pip <- over(waz.shp, md_counties[,"NAME"])

waz.shp$NAME <- md_pip

md_base <- ggplot(md_counties) + geom_map(data = md_counties, map = md_counties,
                                            aes(x = long, y = lat, group = group, map_id = id),
                                            color = "black", fill = NA) +
  ylab(label="") + xlab(label="") +
  theme_minimal() +
  coord_map(projection="albers", lat = 39, lat1 = 45)
```

```{r plotlymap, eval=F}
counties <- map_data("county", "maryland")

waz.shp$tooltiptext <- with(waz.shp@data, paste(city, alert_type, time, sep = "/n"))
waz.shp$tooltiptext <- sub("NA", "", waz.shp$tooltiptext)

edt.shp$tooltiptext <- with(edt.shp@data, paste(County, HighestInj, time, sep = "/n"))
edt.shp$tooltiptext <- sub("NA", "", edt.shp$tooltiptext)


map.p <- ggplot() +
  ggtitle("2017-08-01 Spatial Overlay") +
  geom_polygon(data = counties, aes(x = long, y = lat, group = group), 
               color = "white", fill = "grey80") + theme_void() +
coord_fixed(1.3) +

  geom_point(data = waz.shp[format(waz.shp$time, "%d") == "01",]@data, # 2017-08-01 first
             aes(
               x = longitude, 
               y = latitude, 
               color = alert_type,
                text = tooltiptext),
             shape = 16) +

  geom_point(data = edt.shp[format(edt.shp$time, "%d") == "01",]@data, # 2017-08-01 first
             aes(
               x = GPSLong_Ne, 
               y = GPSLat, 
               text = tooltiptext,
               color = 'EDT'),
             shape = 16) +
  scale_color_brewer(palette = "Set1",
                        name = "Waze Alert Type and EDT Crash")

  
ggplotly(map.p, tooltip = "text", width = 1000)

```

### Table of Waze events by day 

```{r freqevents, fig.width=12}
# make a table of frequency of type by time of day
d$timeofday <- as.numeric(paste(as.numeric(format(d$time, "%H")), round(100*as.numeric(format(d$time, "%M"))/60, 0), sep = "."))

gp <- ggplot(d@data, aes(timeofday, color = type)) + 
  geom_freqpoly(bins = 50)

ggplotly(gp)

```


### Spatiotemporal join

```{r stjoin, warning = F, eval = F} 

# for each EDT event, find the number and distance for nearest neighbors in space and time from Waze data
ex <- edt.shp@data

distbreaks <- c(0, 0.1, 0.5, 1, 5, 10, 15, 25, 50, 100, 300, 1000)
distcounts <- vector()

for(i in 1:nrow(ex)){

  daterangemin <- ex[i, 'time'] - 2*60*60
  daterangemax <- ex[i, 'time'] + 2*60*60
    
  # find waze events within 3 hrs of this crash
  
  wx <- waz.shp[waz.shp$time > daterangemin & waz.shp$time < daterangemax,]
  
  if(nrow(wx) ==0) {
    b <- rep(0, length(distbreaks))
  } else {
  w_sp <- SpatialPoints(coords = data.frame(wx$longitude, wx$latitude))
  e_sp <- SpatialPoints(coords = data.frame(ex[i,'GPSLong_Ne'], ex[i,'GPSLat']))
  
  t1 <- spDists(w_sp, e_sp, longlat = T) # distance in km to each edt event
  
  # Sum of events with 0.1 to 100 mi in various chunks
  b <- hist(t1, breaks = distbreaks, plot = F)$counts
  }

  distcounts <- rbind(distcounts, b)
  
  # Sum of events within 1 to 120 minutes
  
  }

colnames(distcounts) = distbreaks[2:length(distbreaks)]
rownames(distcounts) = ex$ID

dm <- melt(distcounts)
colnames(dm) <- c("ID", "Bin", "Count")
dm$Bin <- as.factor(dm$Bin)

gp <- ggplot(dm) + geom_histogram(aes(x = Count), bins = 50) + facet_wrap(~Bin) + ylab("Frequency") + xlab("Count of Waze Events")

ggplotly(gp, width = 1000, tooltip = c("count"))

```