---
title: "EDT + Waze April 2017"
output:
  html_document:
    df_print: paged
---

## Working with linked EDT and Waze incident data for April 2017

Started 2017-12-07

Ideas:

- Frequency of events - histograms of different Waze event frequencies within a day, for different event types (accident, jam, weather hazard, road closed), and same for EDT incident count frequencies within a day
- Incident type by time of day
- Duration of incidents
- Spatial overlay of events - similar to Lia's slider idea, make a figure which builds up hotspots of Waze and EDT by day
- Spatiotemporal join - Paul's 2x2 for time (early, laggy) and space (near, far) matching of EDT and Waze, by type. In the future, using data snapped to HPMS, use roadway classification as well, or could use day of week.

```{r setup, message = F, warning = F}
# Read in libraries and set working directory
knitr::opts_chunk$set(echo = F, warning=F, message=F)
options(width = 2400, stringsAsFactors = F)

library(tidyverse)
library(maps) # for mapping base layers
library(reshape)
library(DT) # for interatctive datatable
# devtools::install_github("ropensci/plotly") # for latest version
library(plotly) # do after ggplot2
library(sp)
library(maptools) # readShapePoly() and others
library(mapproj) # for coord_map()
library(rgdal) # for readOGR(), needed for reading in ArcM shapefiles
library(rgeos) # for gIntersection, to clip two shapefiles
library(knitr)
library(kableExtra) # formatting tables 

#Set file locations

if(length(grep("flynn", getwd())) > 0) {mappeddrive = "W:"} # change this to match the mapped network drive on your machine (Z: in original)
if(length(grep("sudderth", getwd())) > 0) {mappeddrive = "S:"} 

wazedir <- (file.path(mappeddrive,"SDI Pilot Projects/Waze"))
volpewazedir <- "//vntscex.local/DFS/Projects/PROJ-OR02A2/SDI/"
 
knitr::opts_knit$set(root.dir = wazedir)  # setwd(wazedir) # to develop code in working R session
```

```{r dataimport}
# Read in merged Waze and EDT data 
ew <- readRDS(file.path(wazemonthdir, "merged.waze.edt.April_MD.rds"))

# Read in county data from Census
counties <- readOGR(file.path(wazedir, "Working Documents/Census Files"), layer = "cb_2015_us_county_500k")
md_counties <- counties[counties$STATEFP == 24,]

```


```{r linksummary, echo = F}

```


```{r matchtable}

## Calculations for EDT/Waze match table
Total.EDT.events <- length(unique(edt.april$ID))
EDT.events.with.Waze <- length(unique(link$id.edt))
EDT.events.without.Waze <- Total.EDT.events - EDT.events.with.Waze
Pct.EDT.match <- round(100*EDT.events.with.Waze/Total.EDT.events,2)

Total.Waze.events <- length(unique(d$uuid))
Waze.events.with.EDT <- length(unique(link$uuid.waze))
Waze.events.without.EDT <- Total.Waze.events - Waze.events.with.EDT
Pct.Waze.match <- round(100*Waze.events.with.EDT/Total.Waze.events,2)


mm <- matrix(c(EDT.events.with.Waze, EDT.events.without.Waze, Total.EDT.events, Pct.EDT.match,
         Waze.events.with.EDT, Waze.events.without.EDT,Total.Waze.events, Pct.Waze.match), byrow=T,
       nrow = 2, ncol = 4)

row.names(mm) <- c("EDT", "Waze")
colnames(mm) <- c("Matching", "Non-Matching", "Total", "Percent Matching")

kable(mm) %>% kable_styling(bootstrap_options = c("hover"))


# by type



```

### Initial mapping work

```{r fort.map, eval=FALSE, include=FALSE}
# Currently not run -- this is the start of making a fortified dataframe for ggplot mapping, to turn into a plotly map.
# Get points in polygons: events in each county
proj4string(edt.shp) <- proj4string(waz.shp) <- proj4string(md_counties)

md_pip <- over(waz.shp, md_counties[,"NAME"])

waz.shp$NAME <- md_pip

md_base <- ggplot(md_counties) + geom_map(data = md_counties, map = md_counties,
                                            aes(x = long, y = lat, group = group, map_id = id),
                                            color = "black", fill = NA) +
  ylab(label="") + xlab(label="") +
  theme_minimal() +
  coord_map(projection="albers", lat = 39, lat1 = 45)
```

```{r plotlymap, eval=F}
counties <- map_data("county", "maryland")

waz.shp$tooltiptext <- with(waz.shp@data, paste(city, alert_type, time, sep = "/n"))
waz.shp$tooltiptext <- sub("NA", "", waz.shp$tooltiptext)

edt.shp$tooltiptext <- with(edt.shp@data, paste(County, HighestInj, time, sep = "/n"))
edt.shp$tooltiptext <- sub("NA", "", edt.shp$tooltiptext)


map.p <- ggplot() +
  ggtitle("2017-08-01 Spatial Overlay") +
  geom_polygon(data = counties, aes(x = long, y = lat, group = group), 
               color = "white", fill = "grey80") + theme_void() +
coord_fixed(1.3) +

  geom_point(data = waz.shp[format(waz.shp$time, "%d") == "01",]@data, # 2017-08-01 first
             aes(
               x = longitude, 
               y = latitude, 
               color = alert_type,
                text = tooltiptext),
             shape = 16) +

  geom_point(data = edt.shp[format(edt.shp$time, "%d") == "01",]@data, # 2017-08-01 first
             aes(
               x = GPSLong_Ne, 
               y = GPSLat, 
               text = tooltiptext,
               color = 'EDT'),
             shape = 16) +
  scale_color_brewer(palette = "Set1",
                        name = "Waze Alert Type and EDT Crash")

  
ggplotly(map.p, tooltip = "text", width = 1000)

```

### Table of Waze events by day 

```{r freqevents, fig.width=12}
# make a table of frequency of type by time of day
d$timeofday <- as.numeric(paste(as.numeric(format(d$time, "%H")), round(100*as.numeric(format(d$time, "%M"))/60, 0), sep = "."))

gp <- ggplot(d@data, aes(timeofday, color = type)) + 
  geom_freqpoly(bins = 50)

ggplotly(gp)

```


### Spatiotemporal join

```{r stjoin, warning = F, eval = F} 

# for each EDT event, find the number and distance for nearest neighbors in space and time from Waze data
ex <- edt.shp@data

distbreaks <- c(0, 0.1, 0.5, 1, 5, 10, 15, 25, 50, 100, 300, 1000)
distcounts <- vector()

for(i in 1:nrow(ex)){

  daterangemin <- ex[i, 'time'] - 2*60*60
  daterangemax <- ex[i, 'time'] + 2*60*60
    
  # find waze events within 3 hrs of this crash
  
  wx <- waz.shp[waz.shp$time > daterangemin & waz.shp$time < daterangemax,]
  
  if(nrow(wx) ==0) {
    b <- rep(0, length(distbreaks))
  } else {
  w_sp <- SpatialPoints(coords = data.frame(wx$longitude, wx$latitude))
  e_sp <- SpatialPoints(coords = data.frame(ex[i,'GPSLong_Ne'], ex[i,'GPSLat']))
  
  t1 <- spDists(w_sp, e_sp, longlat = T) # distance in km to each edt event
  
  # Sum of events with 0.1 to 100 mi in various chunks
  b <- hist(t1, breaks = distbreaks, plot = F)$counts
  }

  distcounts <- rbind(distcounts, b)
  
  # Sum of events within 1 to 120 minutes
  
  }

colnames(distcounts) = distbreaks[2:length(distbreaks)]
rownames(distcounts) = ex$ID

dm <- melt(distcounts)
colnames(dm) <- c("ID", "Bin", "Count")
dm$Bin <- as.factor(dm$Bin)

gp <- ggplot(dm) + geom_histogram(aes(x = Count), bins = 50) + facet_wrap(~Bin) + ylab("Frequency") + xlab("Count of Waze Events")

ggplotly(gp, width = 1000, tooltip = c("count"))

```